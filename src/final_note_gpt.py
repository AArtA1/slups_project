#!/usr/bin/env python
# coding: utf-8

# %% [markdown]
# # ÐŸÑ€Ð¾ÐµÐºÑ‚: ÐœÐ¾Ð´ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ð²Ð¾Ðº (CIR), ÐºÑƒÑ€ÑÐ° USD/RUB Ð¸ Ð¿Ñ€Ð°Ð¹ÑÐ¸Ð½Ð³ Range Accrual
# 
# Ð’ ÑÑ‚Ð¾Ð¼ Ð½Ð¾ÑƒÑ‚Ð±ÑƒÐºÐµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð´Ð²Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:
# 
# 1. **ÐšÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ° Ð¸ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ Ñ‚Ñ€Ñ‘Ñ… ÑÐºÐ¾Ñ€Ñ€ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ€Ð¸ÑÐº-Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð¾Ð²:**
#    - ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° Ð² Ñ€ÑƒÐ±Ð»ÑÑ… (RUONIA) Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸ ÐšÐ¾ÐºÑÐ°â€“Ð˜Ð½Ð³ÐµÑ€ÑÐ¾Ð»Ð»Ð°â€“Ð Ð¾ÑÑÐ° (CIR);
#    - ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° Ð² Ð´Ð¾Ð»Ð»Ð°Ñ€Ð°Ñ… Ð¡Ð¨Ð (SOFR) Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸ CIR;
#    - Ð¾Ð±Ð¼ÐµÐ½Ð½Ñ‹Ð¹ ÐºÑƒÑ€Ñ USD/RUB Ð² Ð»Ð¾Ð³Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð¾Ð´ÐµÐ»Ð¸ (Ð³ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð±Ñ€Ð¾ÑƒÐ½Ð¾Ð²ÑÐºÐ¾Ðµ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ).
# 
# 2. **ÐžÑ†ÐµÐ½ÐºÐ° ÑÐ¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ð¾Ð¹ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Range Accrual Ð´ÐµÑ€Ð¸Ð²Ð°Ñ‚Ð¸Ð²Ð°** Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¹ ÐºÑƒÑ€ÑÐ° USD/RUB Ð¸ Ñ€ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸.
# 
# ÐŸÐ¾ Ñ…Ð¾Ð´Ñƒ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:
# - ÐºÐ°Ð»Ð¸Ð±Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ CIR Ð¿Ð¾ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ð¼ (2019â€“2021);
# - ÐºÐ°Ð»Ð¸Ð±Ñ€ÑƒÐµÐ¼ Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÐºÑƒÑ€ÑÐ° USD/RUB Ð¿Ð¾ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð»Ð¾Ð³-Ð´Ð¾Ñ…Ð¾Ð´Ð½Ð¾ÑÑ‚ÑÐ¼;
# - Ð·Ð°Ð´Ð°Ñ‘Ð¼ Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐºÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¾Ð½Ð½ÑƒÑŽ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ñƒ Ð´Ð»Ñ Ñ‚Ñ€Ñ‘Ñ… Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð¾Ð²;
# - Ð¿Ñ€Ð¾Ð²Ð¾Ð´Ð¸Ð¼ ÐœÐ¾Ð½Ñ‚Ðµ-ÐšÐ°Ñ€Ð»Ð¾ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¸ Ð¸ Ð¾Ñ†ÐµÐ½Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²ÑƒÑŽ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Range Accrual.
# 
# ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ð¾ Ð´Ð°Ñ‘Ð¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð°:
# - Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ (Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑÑ€ÐµÐ´Ð½ÐµÐ³Ð¾, ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° Ðº ÑÑ€ÐµÐ´Ð½ÐµÐ¼Ñƒ Ð¸ Ñ‚.Ð´.),
# - ÑˆÐ°Ð³Ð° ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¸ Ð¸ Ñ‡Ð¸ÑÐ»Ð° ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¹.


# %% [markdown]
# ## 1. Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº Ð¸ Ð²ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¼Ð¾Ð´ÑƒÐ»ÐµÐ¹

# %%
import os

import numpy as np
import pandas as pd
import statsmodels.api as sm
import matplotlib.pyplot as plt

from utils import plot_history, ols_cir   # plot_history â€“ Ð´Ð»Ñ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð², ols_cir â€“ Ð´Ð»Ñ ÐºÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ¸ CIR
import model                             # model.estimate_fx_vol_from_series â€“ ÐºÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ° Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ FX

# Ð”Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð° ÑƒÐºÐ°Ð¶ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
data_dir = "../data"


# %% [markdown]
# ## 2. ÐšÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ° CIR-Ð¼Ð¾Ð´ÐµÐ»Ð¸ Ð´Ð»Ñ Ñ€ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸ (RUONIA)
# 
# Ð—Ð´ÐµÑÑŒ Ð¼Ñ‹:
# 1. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ RUONIA Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´ 2019â€“2021 Ð³Ð³.
# 2. ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð² Ð´Ð¾Ð»Ð¸ (Ð¸Ð· Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð²).
# 3. Ð¡Ñ‚Ñ€Ð¾Ð¸Ð¼ Ð³Ñ€Ð°Ñ„Ð¸Ðº Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÑ‚Ð°Ð²Ð¾Ðº.
# 4. ÐšÐ°Ð»Ð¸Ð±Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¼Ð¾Ð´ÐµÐ»Ð¸ CIR (`kappa`, `theta`, `sigma`) Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð¼ Ð½Ð°Ð¸Ð¼ÐµÐ½ÑŒÑˆÐ¸Ñ… ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð¾Ð² Ð² Ð´Ð¸ÑÐºÑ€ÐµÑ‚Ð½Ð¾Ð¹ AR(1)-Ñ„Ð¾Ñ€Ð¼Ðµ.

# %%
# ÐŸÑƒÑ‚ÑŒ Ðº CSV Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼Ð¸ ÑÑ‚Ð°Ð²ÐºÐ°Ð¼Ð¸ RUONIA
rub_path = os.path.join(data_dir, "RC_F11_01_2010_T10_12_2021.csv")

# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…
df_rub = pd.read_csv(rub_path, delimiter=",", decimal=".")
df_rub.columns = df_rub.columns.str.strip()

# ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð°Ñ‚Ñ‹ Ð¸ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ°
df_rub["Date"] = pd.to_datetime(df_rub["DT"], format="%m/%d/%Y")
df_rub = df_rub.sort_values("Date").set_index("Date")

# ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿ÐµÑ€Ð¸Ð¾Ð´ ÐºÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ¸ 2019-01-01 â€” 2021-12-10
df_rub = df_rub["2019-01-01":"2021-12-10"]

# ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð² Ð´Ð¾Ð»Ð¸ (Ð¸Ð· Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð¾Ð²)
df_rub["r"] = df_rub["ruo"].values / 100.0
r_rub_hist = df_rub["r"].values

# Ð¨Ð°Ð³ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð² Ð³Ð¾Ð´Ð°Ñ… (Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ðµ Ð´Ð½Ð¸)
dt = 1 / 252

print(f"âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ RUONIA Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹! Ð’ÑÐµÐ³Ð¾ Ñ‚Ð¾Ñ‡ÐµÐº: {len(r_rub_hist)}")
print(f"ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÑÑ‚Ð°Ð²Ð¾Ðº (Ð² Ð´Ð¾Ð»ÑÑ…): {r_rub_hist[:5]}")

# Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ñ€ÑƒÐ±Ð»Ñ‘Ð²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸
plot_history(df_rub["r"], "Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÑ‚Ð°Ð²ÐºÐ° RUB (RUONIA)", "Ð¡Ñ‚Ð°Ð²ÐºÐ°, Ð´Ð¾Ð»Ð¸ (Ð¾Ñ‚ 0 Ð´Ð¾ 1)")

# ÐšÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² CIR Ð¿Ð¾ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ð¼
kappa_r_est, theta_r_est, sigma_r_est = ols_cir(r_rub_hist, dt)

print("\n=== ðŸŽ¯ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« ÐšÐÐ›Ð˜Ð‘Ð ÐžÐ’ÐšÐ˜ Ð”Ð›Ð¯ RUONIA (RUB) ===")
print(f"kappa_r: {kappa_r_est:.4f}")
print(f"theta_r: {theta_r_est:.4f}")
print(f"sigma_r: {sigma_r_est:.4f}")


# %% [markdown]
# **Ð˜Ð½Ñ‚ÐµÑ€Ð¿Ñ€ÐµÑ‚Ð°Ñ†Ð¸Ñ:**
# - `kappa_r` â€” ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð° RUB-ÑÑ‚Ð°Ð²ÐºÐ¸ Ðº Ð´Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ ÑƒÑ€Ð¾Ð²Ð½ÑŽ `theta_r`;
# - `theta_r` â€” Ð´Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡Ð½Ð¾Ðµ ÑÑ€ÐµÐ´Ð½ÐµÐµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ RUONIA;
# - `sigma_r` â€” Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸.
# 
# Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ñ‚Ð¾ ÐµÑÑ‚ÑŒ Ð¼Ð¾Ð´ÐµÐ»ÑŒ CIR Ð¿Ð¾Ð´ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ð¿Ð¾Ð´ Ñ€ÐµÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÑƒ ÑÑ‚Ð°Ð²Ð¾Ðº.


# %% [markdown]
# ## 3. ÐšÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ° CIR Ð´Ð»Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸ (SOFR)
# 
# ÐÐ½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾ RUB:
# 1. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ SOFR.
# 2. ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¾Ð»Ð¸.
# 3. Ð¡Ñ‚Ñ€Ð¾Ð¸Ð¼ Ð³Ñ€Ð°Ñ„Ð¸Ðº.
# 4. ÐšÐ°Ð»Ð¸Ð±Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ CIR.

# %%
usd_path = os.path.join(data_dir, "SOFR.csv")

df_usd = pd.read_csv(usd_path)
df_usd["Date"] = pd.to_datetime(df_usd["observation_date"])
df_usd = df_usd.sort_values("Date").set_index("Date")

# ÐŸÐµÑ€Ð¸Ð¾Ð´ ÐºÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ¸
df_usd = df_usd["2019-01-01":"2021-12-10"]

# ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð² Ð´Ð¾Ð»Ð¸
df_usd["r"] = df_usd["SOFR"].values / 100.0
r_usd_hist = df_usd["r"].dropna().values

dt = 1 / 252

print(f"âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ SOFR Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹! Ð’ÑÐµÐ³Ð¾ Ñ‚Ð¾Ñ‡ÐµÐº: {len(r_usd_hist)}")
print(f"ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÑÑ‚Ð°Ð²Ð¾Ðº (Ð² Ð´Ð¾Ð»ÑÑ…): {r_usd_hist[:5]}")

# Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸
plot_history(df_usd["r"], "Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑÑ‚Ð°Ð²ÐºÐ° USD (SOFR)", "Ð¡Ñ‚Ð°Ð²ÐºÐ°, Ð´Ð¾Ð»Ð¸ (Ð¾Ñ‚ 0 Ð´Ð¾ 1)")

# ÐšÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ° CIR Ð´Ð»Ñ USD
kappa_d_est, theta_d_est, sigma_d_est = ols_cir(r_usd_hist, dt)

print("\n=== ðŸŽ¯ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« ÐšÐÐ›Ð˜Ð‘Ð ÐžÐ’ÐšÐ˜ Ð”Ð›Ð¯ SOFR (USD) ===")
print(f"kappa_d: {kappa_d_est:.4f}")
print(f"theta_d: {theta_d_est:.4f}")
print(f"sigma_d: {sigma_d_est:.4f}")


# %% [markdown]
# ## 4. ÐšÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ° Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ ÐºÑƒÑ€ÑÐ° USD/RUB
# 
# Ð”Ð»Ñ Ð¾Ð±Ð¼ÐµÐ½Ð½Ð¾Ð³Ð¾ ÐºÑƒÑ€ÑÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð»Ð¾Ð³Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¼Ð¾Ð´ÐµÐ»ÑŒ:
# \[
# d\ln S_t = \left(\mu - \frac{1}{2}\sigma_{FX}^2\right)dt + \sigma_{FX} dW_t^{FX}.
# \]
# 
# Ð—Ð´ÐµÑÑŒ Ð½Ð°Ñ Ð¿Ñ€ÐµÐ¶Ð´Ðµ Ð²ÑÐµÐ³Ð¾ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÑƒÐµÑ‚ **Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ** \(\sigma_{FX}\), ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð¼Ñ‹ Ð¾Ñ†ÐµÐ½Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ð¾ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð»Ð¾Ð³-Ð´Ð¾Ñ…Ð¾Ð´Ð½Ð¾ÑÑ‚ÑÐ¼ ÐºÑƒÑ€ÑÐ° USD/RUB.

# %%
usd_rub_path = os.path.join(data_dir, "usdrub_data.csv")

df_fx = pd.read_csv(usd_rub_path)
df_fx["Date"] = pd.to_datetime(df_fx["Date"])
df_fx = df_fx.sort_values("Date").set_index("Date")

# ÐŸÐµÑ€Ð¸Ð¾Ð´ ÐºÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ¸, ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ñ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð¾Ð¼ ÑÑ‚Ð°Ð²Ð¾Ðº
df_fx = df_fx["2019-01-01":"2021-12-10"]

# ÐžÑ†ÐµÐ½ÐºÐ° Ð³Ð¾Ð´Ð¾Ð²Ð¾Ð¹ Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ ÐºÑƒÑ€ÑÐ° Ð¿Ð¾ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð»Ð¾Ð³-Ð´Ð¾Ñ…Ð¾Ð´Ð½Ð¾ÑÑ‚ÑÐ¼
sigma_fx_annual, sigma_fx_daily, log_ret = model.estimate_fx_vol_from_series(
    df_fx["RUB=X"],
    dt_years=1 / 252,
)

print("\n=== ðŸŽ¯ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« Ð”Ð›Ð¯ USD/RUB ===")
print(f"Ð“Ð¾Ð´Ð¾Ð²Ð°Ñ Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ sigma_FX: {sigma_fx_annual:.4f}")


# %% [markdown]
# ## 5. Ð¤Ð¸ÐºÑÐ°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ð¸ Ñ€Ñ‹Ð½Ð¾Ñ‡Ð½Ñ‹Ñ… ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹ Ð½Ð° 10.12.2021
# 
# ÐÐ° ÑÑ‚Ð¾Ð¼ ÑˆÐ°Ð³Ðµ:
# - Ð·Ð°Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ´ÐµÐ»ÐºÐ¸ Range Accrual;
# - Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ñ€Ñ‹Ð½Ð¾Ñ‡Ð½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð½Ð° Ð´Ð°Ñ‚Ñƒ Ð¾Ñ†ÐµÐ½ÐºÐ¸ (ÐºÑƒÑ€Ñ, ÑÑ‚Ð°Ð²ÐºÐ¸);
# - Ð·Ð°Ð´Ð°Ñ‘Ð¼ (Ð¸Ð»Ð¸ Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð· ÐºÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ¸) Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ CIR Ð¸ FX.

# %%
# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐ´ÐµÐ»ÐºÐ¸ (Range Accrual)
Notional = 1_000_000      # ÐÐ¾Ð¼Ð¸Ð½Ð°Ð» (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 1 Ð¼Ð»Ð½ Ñ€ÑƒÐ±)
T_years = 1.0             # Ð¡Ñ€Ð¾Ðº ÑÐ´ÐµÐ»ÐºÐ¸ (1 Ð³Ð¾Ð´)
Lower_Barrier = 70.0      # ÐÐ¸Ð¶Ð½ÑÑ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð° ÐºÑƒÑ€ÑÐ°
Upper_Barrier = 80.0      # Ð’ÐµÑ€Ñ…Ð½ÑÑ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð° ÐºÑƒÑ€ÑÐ°

# Ð Ñ‹Ð½Ð¾Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½Ð° 10.12.2021 (Ð´Ð°Ñ‚Ð° Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ´ÐµÐ»ÐºÐ¸)
S0 = 73.70       # Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÑƒÑ€Ñ USDRUB
r_rub_0 = 0.0745  # Ð¢ÐµÐºÑƒÑ‰Ð°Ñ RUONIA (Ð² Ð´Ð¾Ð»ÑÑ…)
r_usd_0 = 0.0005  # Ð¢ÐµÐºÑƒÑ‰Ð°Ñ SOFR (Ð¾ÐºÐ¾Ð»Ð¾ Ð½ÑƒÐ»Ñ, Ð² Ð´Ð¾Ð»ÑÑ…)

# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ (Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð·ÑÑ‚Ñ‹ Ð¸Ð· ÐºÐ°Ð»Ð¸Ð±Ñ€Ð¾Ð²ÐºÐ¸ Ð¸Ð»Ð¸ ÑÐ»ÐµÐ³ÐºÐ° ÑÐ³Ð»Ð°Ð¶ÐµÐ½Ñ‹)
# Ð—Ð´ÐµÑÑŒ, Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ:
kappa_r, theta_r, sigma_r = 1.5546, 0.0582, 0.0936    # RUB (CIR)
kappa_d, theta_d, sigma_d = 1.3472, 0.0022, 0.1695    # USD (CIR)
sigma_fx = 0.1391                                     # FX (LogNormal, Ð³Ð¾Ð´Ð¾Ð²Ð°Ñ Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ)


# %% [markdown]
# ## 6. ÐšÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ð° Ñ‚Ñ€Ñ‘Ñ… Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð¾Ð²
# 
# ÐœÑ‹ Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑˆÑƒÐ¼Ñ‹ Ñ‚Ñ€Ñ‘Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²:
# - ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° RUB,
# - ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° USD,
# - Ð»Ð¾Ð³Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÑƒÑ€Ñ USD/RUB
# 
# ÑÐ²Ð»ÑÑŽÑ‚ÑÑ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð½Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¹ ÐºÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†ÐµÐ¹. ÐÐ¸Ð¶Ðµ Ð·Ð°Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÐºÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¹
# (Ð¾Ñ†ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð¾ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ð¼ Ð¸Ð»Ð¸ Ð·Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ðº Ñ€Ð°Ð·ÑƒÐ¼Ð½Ð°Ñ Ð°Ð¿Ð¿Ñ€Ð¾ÐºÑÐ¸Ð¼Ð°Ñ†Ð¸Ñ).

# %%
corr_data = [
    [1.0000, 0.0382, 0.0098],
    [0.0382, 1.0000, -0.0177],
    [0.0098, -0.0177, 1.0000],
]
corr_matrix = np.array(corr_data)

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½Ð½Ð¾ÑÑ‚ÑŒ (Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ€Ð°Ð·Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¥Ð¾Ð»ÐµÑ†ÐºÐ¾Ð³Ð¾)
L = np.linalg.cholesky(corr_matrix)


# %% [markdown]
# ## 7. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÐœÐ¾Ð½Ñ‚Ðµ-ÐšÐ°Ñ€Ð»Ð¾ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¸
# 
# Ð—Ð´ÐµÑÑŒ Ð·Ð°Ð´Ð°Ñ‘Ð¼:
# - `N_sim` â€” ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÐµÐ² (Ð¿ÑƒÑ‚ÐµÐ¹),
# - `N_steps` â€” ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸,
# - `dt` â€” ÑˆÐ°Ð³ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð² Ð³Ð¾Ð´Ð°Ñ….
# 
# Ð¨Ð°Ð³ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð´Ð½ÐµÐ²Ð½Ñ‹Ð¼ (252 ÑˆÐ°Ð³Ð° Ð² Ð³Ð¾Ð´), Ñ‡Ñ‚Ð¾ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ñ‹Ð¼ ÐºÐ¾Ð¼Ð¿Ñ€Ð¾Ð¼Ð¸ÑÑÐ¾Ð¼ Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¸ Ð²Ñ‹Ñ‡Ð¸ÑÐ»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒÑŽ.

# %%
N_sim = 10_000      # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿ÑƒÑ‚ÐµÐ¹
N_steps = 252       # Ð§Ð¸ÑÐ»Ð¾ ÑˆÐ°Ð³Ð¾Ð² Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ (Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ðµ Ð´Ð½Ð¸ Ð² Ð³Ð¾Ð´Ñƒ)
dt = T_years / N_steps

print(f"Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¸: {N_sim} Ð¿ÑƒÑ‚ÐµÐ¹, {N_steps} ÑˆÐ°Ð³Ð¾Ð² (dt = {dt:.6f} Ð»ÐµÑ‚)")


# %% [markdown]
# ## 8. Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸: ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ Ñ€Ñ‹Ð½ÐºÐ° Ð¸ Ð¿Ñ€Ð°Ð¹ÑÐ¸Ð½Ð³ Range Accrual
# 
# Ð”Ð»Ñ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ Ð¿Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð·Ð°Ð´Ð°Ñ‡Ð¸:
# - Ñ€ÐµÐ°Ð»Ð¸Ð·ÑƒÐµÐ¼ **Ð¼Ð¾Ð´ÑƒÐ»ÑŒ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¸** Ñ‚Ñ€Ñ‘Ñ… Ñ€Ð¸ÑÐº-Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð¾Ð²;
# - Ñ€ÐµÐ°Ð»Ð¸Ð·ÑƒÐµÐ¼ **Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð¿Ñ€Ð°Ð¹ÑÐ¸Ð½Ð³Ð°**, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð°, Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸ÑŽ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²ÑƒÑŽ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð´ÐµÑ€Ð¸Ð²Ð°Ñ‚Ð¸Ð²Ð°.


# %%
def simulate_market_paths(
    N_sim: int,
    N_steps: int,
    T_years: float,
    r0_rub: float,
    r0_usd: float,
    s0_fx: float,
    cir_rub_params: tuple,
    cir_usd_params: tuple,
    fx_vol: float,
    corr_matrix: np.ndarray,
    seed: int = 42,
):
    """
    Ð¡Ð¸Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐµÑ‚ Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÑƒ Ñ‚Ñ€ÐµÑ… Ñ€Ð¸ÑÐº-Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð¾Ð²:
    - ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° RUB (CIR),
    - ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ð°Ñ ÑÑ‚Ð°Ð²ÐºÐ° USD (CIR),
    - ÐºÑƒÑ€Ñ USD/RUB (Ð»Ð¾Ð³Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ Ð´Ñ€ÐµÐ¹Ñ„Ð¾Ð¼ r_rub - r_usd).

    ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
    ---------
    N_sim : int
        ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÐµÐ² ÐœÐ¾Ð½Ñ‚Ðµ-ÐšÐ°Ñ€Ð»Ð¾.
    N_steps : int
        ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÑˆÐ°Ð³Ð¾Ð² Ð½Ð° Ð³Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ðµ T_years.
    T_years : float
        Ð“Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚ Ð¼Ð¾Ð´ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ð³Ð¾Ð´Ð°Ñ….
    r0_rub, r0_usd : float
        ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÑ‚Ð°Ð²Ð¾Ðº.
    s0_fx : float
        ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÐºÑƒÑ€ÑÐ° USD/RUB.
    cir_rub_params : (kappa_r, theta_r, sigma_r)
        ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ CIR Ð´Ð»Ñ Ñ€ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸.
    cir_usd_params : (kappa_d, theta_d, sigma_d)
        ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ CIR Ð´Ð»Ñ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸.
    fx_vol : float
        Ð“Ð¾Ð´Ð¾Ð²Ð°Ñ Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð»Ð¾Ð³Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð¾Ð´ÐµÐ»Ð¸ ÐºÑƒÑ€ÑÐ°.
    corr_matrix : np.ndarray
        3x3 ÐºÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ð° Ð´Ð»Ñ (RUB, USD, FX).
    seed : int
        Seed Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ñ… Ñ‡Ð¸ÑÐµÐ» (Ð´Ð»Ñ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸).

    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚
    ----------
    rub_rates, usd_rates, fx_rates, discount_integral : np.ndarray
        ÐœÐ°ÑÑÐ¸Ð²Ñ‹ Ñ‚Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ (N_sim, N_steps+1) Ð¸ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ð» Ñ€ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ñ.
    """
    dt = T_years / N_steps
    kappa_r, theta_r, sigma_r = cir_rub_params
    kappa_d, theta_d, sigma_d = cir_usd_params

    # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð² Ñ‚Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
    rub_rates = np.zeros((N_sim, N_steps + 1))
    usd_rates = np.zeros((N_sim, N_steps + 1))
    fx_rates = np.zeros((N_sim, N_steps + 1))

    rub_rates[:, 0] = r0_rub
    usd_rates[:, 0] = r0_usd
    fx_rates[:, 0] = s0_fx

    # Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ð» Ñ€ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸ (Ð´Ð»Ñ Ð´Ð¸ÑÐºÐ¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
    discount_integral = np.zeros(N_sim)

    # Ð Ð°Ð·Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¥Ð¾Ð»ÐµÑ†ÐºÐ¾Ð³Ð¾ ÐºÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¾Ð½Ð½Ð¾Ð¹ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ñ‹
    L = np.linalg.cholesky(corr_matrix)

    # Ð¤Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ seed Ð´Ð»Ñ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸
    np.random.seed(seed)

    for t in range(N_steps):
        # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ñ… ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ñ… Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ñ…
        Z_uncorr = np.random.normal(0, 1, size=(3, N_sim))
        # Ð’Ð²Ð¾Ð´ ÐºÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¹
        Z = L @ Z_uncorr

        r_r = rub_rates[:, t]
        r_d = usd_rates[:, t]
        S_t = fx_rates[:, t]

        # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ð²ÐºÐ¸ RUB Ð¿Ð¾ CIR
        dr_r = (
            kappa_r * (theta_r - r_r) * dt
            + sigma_r * np.sqrt(np.maximum(r_r, 0)) * np.sqrt(dt) * Z[0, :]
        )
        rub_rates[:, t + 1] = r_r + dr_r

        # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ð²ÐºÐ¸ USD Ð¿Ð¾ CIR
        dr_d = (
            kappa_d * (theta_d - r_d) * dt
            + sigma_d * np.sqrt(np.maximum(r_d, 0)) * np.sqrt(dt) * Z[1, :]
        )
        usd_rates[:, t + 1] = r_d + dr_d

        # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÑƒÑ€ÑÐ° FX (Ð»Ð¾Ð³Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð¿Ð¾Ð´ Ñ€Ð¸ÑÐº-Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼ÐµÑ€Ð¾Ð¹ Ð² RUB)
        # Ð”Ñ€Ð¸Ñ„Ñ‚ = (r_rub - r_usd) - 0.5 * sigma_fx^2
        drift_fx = (r_r - r_d - 0.5 * fx_vol**2) * dt
        diffusion_fx = fx_vol * np.sqrt(dt) * Z[2, :]
        fx_rates[:, t + 1] = S_t * np.exp(drift_fx + diffusion_fx)

        # ÐÐ°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ð»Ð° Ñ€ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð´Ð»Ñ Ð´Ð¸ÑÐºÐ¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        discount_integral += r_r * dt

    return rub_rates, usd_rates, fx_rates, discount_integral


# %%
def price_range_accrual(
    notional: float,
    lower_barrier: float | None,
    upper_barrier: float | None,
    T_years: float,
    r0_rub: float,
    r0_usd: float,
    s0_fx: float,
    cir_rub_params: tuple,
    cir_usd_params: tuple,
    fx_vol: float,
    corr_matrix: np.ndarray,
    N_sim: int = 10_000,
    N_steps: int = 252,
):
    """
    ÐžÑ†ÐµÐ½ÐºÐ° ÑÐ¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ð¾Ð¹ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Range Accrual.

    ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
    ---------
    notional : float
        ÐÐ¾Ð¼Ð¸Ð½Ð°Ð» ÑÐ´ÐµÐ»ÐºÐ¸ (Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð°Ñ Ð²Ñ‹Ð¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ 100% Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð² Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ).
    lower_barrier, upper_barrier : float Ð¸Ð»Ð¸ None
        ÐÐ¸Ð¶Ð½ÑÑ Ð¸ Ð²ÐµÑ€Ñ…Ð½ÑÑ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð°. Ð•ÑÐ»Ð¸ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚,
        Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‚ÑŒ None.
    T_years : float
        Ð¡Ñ€Ð¾Ðº ÑÐ´ÐµÐ»ÐºÐ¸ Ð² Ð³Ð¾Ð´Ð°Ñ….
    r0_rub, r0_usd : float
        ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ðµ ÑÑ‚Ð°Ð²ÐºÐ¸ Ð² Ñ€ÑƒÐ±Ð»ÑÑ… Ð¸ Ð´Ð¾Ð»Ð»Ð°Ñ€Ð°Ñ….
    s0_fx : float
        ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÑƒÑ€Ñ USD/RUB.
    cir_rub_params, cir_usd_params : tuple
        ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ CIR Ð´Ð»Ñ RUB Ð¸ USD.
    fx_vol : float
        Ð“Ð¾Ð´Ð¾Ð²Ð°Ñ Ð²Ð¾Ð»Ð°Ñ‚Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÐºÑƒÑ€ÑÐ°.
    corr_matrix : np.ndarray
        ÐšÐ¾Ñ€Ñ€ÐµÐ»ÑÑ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ð° Ñ‚Ñ€Ñ‘Ñ… Ñ„Ð°ÐºÑ‚Ð¾Ñ€Ð¾Ð².
    N_sim : int
        ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ð¹.
    N_steps : int
        ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÑˆÐ°Ð³Ð¾Ð².

    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚
    ----------
    fair_value : float
        ÐžÑ†ÐµÐ½ÐºÐ° ÑÐ¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ð¾Ð¹ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´ÐµÑ€Ð¸Ð²Ð°Ñ‚Ð¸Ð²Ð°.
    std_error : float
        ÐžÑ†ÐµÐ½ÐºÐ° ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÐœÐ¾Ð½Ñ‚Ðµ-ÐšÐ°Ñ€Ð»Ð¾.
    rub_rates, usd_rates, fx_rates : np.ndarray
        Ð¡Ð¼Ð¾Ð´ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð° Ð¸ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ¾Ð².
    """
    rub_rates, usd_rates, fx_rates, discount_integral = simulate_market_paths(
        N_sim=N_sim,
        N_steps=N_steps,
        T_years=T_years,
        r0_rub=r0_rub,
        r0_usd=r0_usd,
        s0_fx=s0_fx,
        cir_rub_params=cir_rub_params,
        cir_usd_params=cir_usd_params,
        fx_vol=fx_vol,
        corr_matrix=corr_matrix,
    )

    # Ð‘ÐµÑ€ÐµÐ¼ Ð²ÑÐµ ÑˆÐ°Ð³Ð¸, ÐºÑ€Ð¾Ð¼Ðµ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾
    S_paths = fx_rates[:, 1:]  # shape: (N_sim, N_steps)

    # Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ð½Ð¸Ñ Ð² Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½
    in_range = np.ones_like(S_paths, dtype=bool)
    if lower_barrier is not None:
        in_range &= S_paths >= lower_barrier
    if upper_barrier is not None:
        in_range &= S_paths <= upper_barrier

    # Ð”Ð¾Ð»Ñ Ð´Ð½ÐµÐ¹ Ð² Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÑŽ
    accrual_fraction = in_range.mean(axis=1)

    # Ð”Ð¸ÑÐºÐ¾Ð½Ñ‚-Ñ„Ð°ÐºÑ‚Ð¾Ñ€ Ð¿Ð¾ Ñ€ÑƒÐ±Ð»ÐµÐ²Ð¾Ð¹ ÑÑ‚Ð°Ð²ÐºÐµ
    df = np.exp(-discount_integral)

    # Ð’Ñ‹Ð¿Ð»Ð°Ñ‚Ð° Ð¸ Ð¿Ñ€Ð¸Ð²ÐµÐ´Ñ‘Ð½Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸ÑŽ
    payoff = notional * accrual_fraction
    pv_paths = payoff * df

    fair_value = pv_paths.mean()
    std_error = pv_paths.std(ddof=1) / np.sqrt(N_sim)

    return fair_value, std_error, rub_rates, usd_rates, fx_rates


# %% [markdown]
# ## 9. Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð°Ð¹ÑÐ¸Ð½Ð³Ð° Range Accrual Ð¸ Ð²Ñ‹Ð²Ð¾Ð´ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°

# %%
fair_value, std_error, rub_sim, usd_sim, fx_sim = price_range_accrual(
    notional=Notional,
    lower_barrier=Lower_Barrier,
    upper_barrier=Upper_Barrier,
    T_years=T_years,
    r0_rub=r_rub_0,
    r0_usd=r_usd_0,
    s0_fx=S0,
    cir_rub_params=(kappa_r, theta_r, sigma_r),
    cir_usd_params=(kappa_d, theta_d, sigma_d),
    fx_vol=sigma_fx,
    corr_matrix=corr_matrix,
    N_sim=N_sim,
    N_steps=N_steps,
)

print("\n" + "=" * 40)
print("ðŸ’° Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ ÐžÐ¦Ð•ÐÐšÐ˜ RANGE ACCRUAL")
print("=" * 40)
print(f"Ð”Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½:            {Lower_Barrier} - {Upper_Barrier} RUB")
print(f"Ð¡Ð¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ð°Ñ Ñ†ÐµÐ½Ð°:   {fair_value:,.2f} RUB")
print(f"Ð’ % Ð¾Ñ‚ Ð½Ð¾Ð¼Ð¸Ð½Ð°Ð»Ð°:     {(fair_value / Notional) * 100:.2f}%")
print(f"Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°:  Â± {std_error:.2f} RUB")


# %% [markdown]
# ## 10. Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ: ÑÐ¸Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÐºÑƒÑ€ÑÐ° USD/RUB
# 
# Ð”Ð»Ñ Ð¸Ð»Ð»ÑŽÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 100) ÑÐ¸Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ‚Ñ€Ð°ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ ÐºÑƒÑ€ÑÐ° ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð°
# Ð²Ð¼ÐµÑÑ‚Ðµ Ñ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð°Ð¼Ð¸ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð° Range Accrual.

# %%
plt.figure(figsize=(12, 6))

# Ð Ð¸ÑÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 100 Ð¿ÑƒÑ‚ÐµÐ¹
num_paths_to_plot = min(100, fx_sim.shape[0])
plt.plot(fx_sim[:num_paths_to_plot, :].T, alpha=0.1)

# Ð›Ð¸Ð½Ð¸Ð¸ Ð±Ð°Ñ€ÑŒÐµÑ€Ð¾Ð²
plt.axhline(Upper_Barrier, linestyle="--", label="Ð’ÐµÑ€Ñ…Ð½ÑÑ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð°", linewidth=1.5)
plt.axhline(Lower_Barrier, linestyle="--", label="ÐÐ¸Ð¶Ð½ÑÑ Ð³Ñ€Ð°Ð½Ð¸Ñ†Ð°", linewidth=1.5)

plt.title("Ð¡Ð¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ Ð¿ÑƒÑ‚ÐµÐ¹ ÐºÑƒÑ€ÑÐ° USD/RUB (Monte Carlo)")
plt.xlabel("Ð¨Ð°Ð³ (Ð´ÐµÐ½ÑŒ)")
plt.ylabel("ÐšÑƒÑ€Ñ USD/RUB")
plt.legend()
plt.grid(alpha=0.3)
plt.tight_layout()
plt.show()
